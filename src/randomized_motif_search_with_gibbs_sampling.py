__author__ = 'nikita_kartashov'

from random import randrange
from copy import copy

from randomized_motif_search import randomized_motif_search_wrapper, build_profile_columns_with_corrections
from profile_most_probable_kmer import probability_score
from greedy_motif_search import matrix_score
from utils.pyutils import choose_by_snd_and_ignore, without_nth
from utils.bioutils import all_possible_kmers_from_text


def build_kmer_probabilities(dna_string, k, profile):
    return [(kmer, probability_score(kmer, profile)) for kmer in all_possible_kmers_from_text(dna_string, k)]


def step_builder_with_gibbs_sampling(dna_strings, k, best_motifs, profile_builder):
    leave_out = randrange(len(dna_strings))
    profile = profile_builder(without_nth(best_motifs, leave_out))
    new_motifs = copy(best_motifs)
    new_motifs[leave_out] = choose_by_snd_and_ignore(build_kmer_probabilities(dna_strings[leave_out], k, profile))
    new_score = matrix_score(new_motifs)
    return new_motifs, new_score


if __name__ == '__main__':
    DNA_STRINGS = """TCACCGCCACGGGCCCGTTGACCCCGGCCGCTCCAGTCAGCCGATATACTCGGAGATTGAAGCTGATGTCGAGTTACCTGGTTTAGCACAATCATCTGCTTTTCGAAGCATCGATAAGTATCAATTCTTCAAGGAGCTCCAGGAGCCCTTACGTTGAACTGGATGGTACCGAGTATTTCACGGAGACACACAACTAACACTAAAGAATACCGACAACAAAGCCGTGTCGCAAACGATTGAGATCGACTTCCGGTGCCATTCGACATTATACATGTTATTCCGTTCTCGTTGTATAAATATGCCATGCCAAATTCAAGTTCACCGCCACGGGCC
CGTTGACCCCGGCCGCTCCAGTCAGCCGATATACTCGGAGATTGAAGCTGATGTCGAGTTACCTGGTTTAGCACAATCATCTGCTTTTCGAAGCATCGATAAGTATCAATTCTTCAAGGAGCTCCAGGAGCCCTTACGTTGAACTGGATGTGAAACTTCCATTATGTACCGAGTATTTCACGGAGACACACAACTAACACTAAAGAATACCGACAACAAAGCCGTGTCGCAAACGATTGAGATCGACTTCCGGTGCCATTCGACATTATACATGTTATTCCGTTCTCGTTGTATAAATATGCCATGCCAAATTCAAGTTCACCGCCACGGGCC
TCCCGGTTGTTACTCGAGCGCGGCTATAGCTGCAACCCGCTGTTAAATATGCAGAGTACTTTGCATACTTAGCTCTTAGGGGTGTCATCGGCCAAGCCGACAGATTATTGACTAAACTAGGCATGAACCACTATTGAGCCCAAGCTTGTCGGATGTCGCAATCGCCAACAGTATCAAAGATATGTGTTCCGGGGTACTAGCAGAGGGTCTTTTTGCGAACTACCGAATAGGTCAGTAAGTACTGGCACGGTTTAGAGAACGGCTTTCTCATCCCCGTTCCATTATCGGGGGGGAATCCCAACTAGGCTATCGTTCTATTATCCCACTGAACGA
TGGGGCTGCCTTCCGGGGAGAGACCGCGTTCTTCACACGCAACTGGCGCTTGACATTGACGTGGTCCCAGCTTGGCTAAACGACACGTGGAGAAACGTAAGGAGGCCCGGTTAGGTTTACGTCTTGGGCGCTATCGAGGTTCTGTTGTTATTTAAACATGATATCTCATCCACCGTTGGATCATTATCCAGCTACTTGTATACACCCACTTTCTTCACGCACTGATCTAGCCATTATTTGGGTACGATACAGGGAGTCTGGTTCCATGTACCGTCGGTATTATGGTAATCCCCCGCCTTTCTTAGTCTGCAATCCAATGATCTTCGCCGGTTA
ACTTACCATTCGGACTCCGTTTCTATCCTTTTGTTATCGGAGGCGTGCTTTTTTGGTGAACCCCAGCTAGAACCTATGACCGAGGCATTTCATGGCTTGTACTTGTGATCAGACCATTATCGTGTAACAAAGTAGAAGAGCGCCCATTGGCACCACTGGCGCTGCATGCTGCACACAGCGTCTATGAGTGAGTCTTTTCGACGAAGCAGCCTAAGCCGAGTATTTCACTACAAGGCGACAACCATCTGCCAGTATAGGCTTGTCTCTGCGATGTCTAATGGCGTCGATAGCTACAGGATCAACGCCCCGCCTCACGGCTAACTTCATCTTTTC
TCTACGCCTCGGGATGGGGTGTGGAGGCTGCCAGAGAGTCGAGAGGGCGCGAGGACGGCCCCAAAAGTGGCTCGTGATCGTTCGGATATCCCTCGTAGTTGCAACTGCCCGCACTAGAGTACGCAGTATCAAGGCGCTTAGAACGACGAAAAGTTCACGCTTTATAAGGCGATACTACCCCAGAGAGGCGCATAAAAACAGGCAAGCTTTATAGTCCCATTTCGTGAAAACAGCCTCTTAGTGAAAGATTAAGAGACGTGCCTATTCCTACCGACTTGTCTTGGTTTAACCAACGGTTTTACGAGGTATTGGGGATATAGACCACCAATAGTT
TGACCACACGCATGGGCGGGTCACCCTCCAATCGTGCATTCGGCCAACTTCCGGGTACATTTCATATATTCATAACAGACTACTATTTTATCCACTCCTAGGTAATCGACGCGCGGTGCGCGCGTCATCAGAAGGGACAATGCTGATCGTACGATTCGGTCGAAACACAAGTTGAACTAAGCCATATTACCTGAATCACAAATACAGCGAGCAATGTAACTCCCCAGGTAGCTTGACGTTGATTTGGCTTAGTGGAAAGTGAGAACGTTGCGTTGGGAGAATTCCAAACGCACAGTGCGCTGGCTAGCCCGAATTCGTTCCATTATCCTAAGG
ATTCGGATACTTTGCGTTTGGGCGTCCAGGCCTGACGAGTGTTTGGCATCGAGGGCCGGTTGGACGTGTTTGTTATCATTTAGAAGTCACTGCTGAGGTGTCGTCTAAGGATCGTTCCATTGAGAATTTCGTCTGAATAATGGCTCCGGACTGAGCGATAGAAAACATGCTACTAATGGGAATTTTGGGGTACTTTGGTTTGTGTTCAGTTGTAGCTAGCTAATATCATCTGCCTTATTCCGTCGCGTCCTTATGTGGCGTTTTTTGTTTAATCTGAATTCACGGAAAAGAGACTCCGTAGTCCCCCGTGCAAAGCTCCACCGGAAGGAACTG
CAGTTCGCCTAGTGGTTTTATCGCTATGTATTCATCCGGACCGTCTTACCTAAACGAGTGGTCCGCGCGCCGGTCTAAGTAGGGGTGAGGTTTCTAACTGAGGGATGTCTTGTAATGATCGTAGGATTATACTGGGCTTGTGCAAGTTCCTCATATGTGTAAGCCCCGAGATACGACGATATCCGGTATTTCATCTTGATCTAAAAGGTACGTTTAACTACTCTGAGGTTATGGTAAGGGGTCGACGAGTATTTAGAAAGGTTCCTACCCAATCCAGCTGACTGCTGCCGAATTTGATTTGAGACAGTAGGGGTTAGGGCCGGAAGCTTGTGC
ACCTTGCGCAGAGGGGTTATTTCGGCCAAGGATAGATAAGTGGCCTGCTCCTCTTTTTTAGGGGTTCTTTCCTAGCAGGGTCAGCAAGACCGGGTAGCGCCTACTTTATCTGGATCCCTGATCTTAATATCACGGAGCCGGGTCAGAGCCCGCCGACTAACCGGGTCGATTCCGGGTAGTCCACCCTCCTGACTTGCAAACAATGATCGCAACATTATAGGCAAGAATACAACCGGTCGCCTCGATGGGAGTCTGCGGTGTATATGTGTCAGAGGCGTTGTTAAGAAGTCCTATATCGTCACATAGATATAGACCCCAAAATGTGCTAAACTC
ATGATCGTTCCATATCTATGAAAATATCCGTTCGAACAGTCGGACCGGACAATGTGGCGGGCCACGACAACGTATCTGTGGTGTAAGTTCCGCACTGAGCTCATGTGACCAAGATTGAAGTTGTAGGTTATCTTGGATGTCATTCCTCAAGTCGGCAACTGGTGGTGCGTCGGAGGCACCCGTCAGTGTCCGGCTGCTCGTGACTCATAGTACTTTAGTGCCTCAAGTCAAGGGGATGCTTGGACTGCTTGATTGTAATCTCCTCATGACAAATTTAGCAAGGACCAATAGCTAGTGATTGGCCTAATGGATGCGTCCGGCGTTGTAGTGCGT
GTCCGGACGGTATTACTACGTAACAAACTACCTGTCGATTCCCGGGCGCGGGCGTGCCGAAGGTTAAAAGTTTGATACCTGAGGATAGAAATAGAGATTTTGGAGGCCCCTTGCACTTGTGGGCTGATGACGGCGAGATCATCACCGCACGACACTATTATTAGATGTTGACGCTTCCATTATTAAGAGTCGGTAGTCCATCCATTTGGGAACGCTCGGCTGAAGAGAAGGATTTGGCGGAAGGAACTGGACATCAACCTCCGGAGCACATGGACGATATAGTAATCTCCTGACAGTACACGTATTACTCATAACCATACTTTATTTCACGCG
GACACTGCGATGTACAAGAGACTGAGTGCTGCGCAATGTTGTAGGTTCCATTATGAGCCTATCATTAGCATGCTTTAAGGTCTTTCCACGACGGGGTCTACGATTGTGACTGCCGGGGTGCGCGTCCCACAACCAACGGATGACTCATAGGGTCTGGATTATTCGTAACAGAGTCCCATCGGCCTTAGTTCGGCGCATAAACATCATGGTATCCCCAGGTATACCCTTAGCTCCTTCGTCTATCTATTTAACTAGTCCCCTTTGCCGACTAGCGCCTAGGGTGGGGGTGGTTATGTGTGCGGTCTGCAATTGGAGCCGTTTCACTTTGCCACA
CTAGTAAAAGCTACAGTCTTGCGATTGTTTTCGAGTGCCTTACCGAACCAATGTTTATGAATCGGCGACCGAGGGTATCCGCAGCGGCTGCGTGACTCCCGAGCTAGTAGTATTACGTAGACACTGGAATCCTACCGCAGGTCGATAATTCTTCCCAGCTCTTAGCCACTATATTGCGATGAGTAACGCACGCGACCGGGTGTTCTGGGGCCCCTATACGTCGCGTACTAGTTAACATGATATGTCCATTATGCAGTTAACAATTGAAATGTAACCTTGGTTGCATTTCTTTTCCCCTGCAGGAACGTAACTAGCGATAGCTGTGCGCGTTTT
GACCCGTCCAGCGACAGTAATGTGAGTCGCATTGTGATGAAACATGGTGTTGATCGTTCCCCAATTAACTCATAGAAGTGAATCTTTTCTGAGACCATATGTGTCTCCTCTCGGAGTAATTAGCATATCCACAATTTGCATGCGGGTCCAAATCTCCCTACTCACGCCAGCGTCCGCAGCATACGTCGTTCTGTGATATCGTTACGTGGTACAGGCCCCAGGTTCCCGATCTGTGTTGGTATCAGGCCACAGGCTCGGATAATCAAAGTTAGGTTACATCCCGCGTCGATACTCTGCACAGTCCCGACATCTCTGAACACTAATATTTAGTGG
CAGATATAGTCCATTGACGCGTTAGATAACCAAATCAAACGTTCTCGTTCCGATACCGCTGACTCCCAGCCCTCTTTGTCCACTACTATCTCAGCATCGTTATACGATCCAGTCTCTGAGTGATCACGCATGGTCCCAGAGGTGCAATGGGCGTGGGGCATCCAACACCTTTCCCACGAAAACTTAATAGGTTGATCGTTCCACCTTCAAGGAGCGTGCTGGACAATTATTCTACCGGAGTCGAGCGCTTCATCCGTTAGCGCAACTGCCTGCAGTCACTCGCGTCTTCGGTGCTACCCGCTGAGCTGCTCCTTGACTCAAAGGTCACCTACT
GACGAATATTCCCGGTTGACGAACCACAATCATTTTGATAGGTTAGCTATCCAAACCCCTTACGAAGACCACTCGTTAGGTAGTGGCACGTATTAGGCCACAGTCATCAGCAGGCGCGAACATAATCTCCCCCAGAATTTCCTTAGGCTACCATTATAATAGTCGGCTGGCCGGGGATCTGCACGTCGTGTCCTCCCACCACCGCCAACTCATCGGTGAGGACTTGATCGTTTATTTATGCGTAATGTAGCGTAAATTGTCTCTGTTGTTGCAGTAGGGTTAATCACCATGGGACACGACAAATAATCCGCCCCTCAGCCCCTGACATCCCAC
ACGTAACAGTTCACTCTGGCACTCAAGAAAGTGCGCGAGTAGAAGCCTGGATACTGTCCGCGCACGTACGAATGGTTGTAATCAGAGGTGCAACAGTTTCAGAAACGCGTATGGCATGTGCACCACGTTTGATACATCCATTATTATATGTCTTAGTTGAAATGGTTAAGACAAAAGGATCAGTCCGACGGCCATTTTGCGTCTACAGTCTTATCTTTATAAAAGACTAGTCCACGTTATACACTAATAAGAACGAACGGCTTTGCGTACTACTATATGCACACGGCCCCCTTAAACATTACGGGCGGAAGGGGACACTTCGTGGACCAAGCA
GCTGAGTCAGGTATACAACTTGTGAGTCAACATGCTGTCCCATACGCCCTAATCTAGGTTCGAGTTACGGAGGACAACACATCTCAGGTCGCCAGTAAATGGGATGTGACCCGTCCTGACGAAGATCTCCTTCTGACGGTGACTGTCGTATAGATAATTAGCTACTTCACATAACACGAGGGCCGAATGTGGCAATTAGATACTTTTTGATCCCTCGTACTGATGTCGCCAAAGACGTCCCGAGCCCTTAATACAGAGTAACATAGGTGGGTAGAGAAGTTGATCGAGGCATTATAGTCGGTGCTTTTTAGTGCAGACATAAGACCCTGATTC
CCGGTTACCGCGACTACTTAGGAGTAACAGGAGGGTACGGCACACCAGAGGACCCCCGACCAGGCCATGTCCATCTAAAAAACGTACAATCGTATGTTTGTAAAAAGGCGGGTATAGGATGGATTCTTGGGTAAATGGGTAACCTACAATGGACTAATTTTCAGACCCGTAACGGGGGGAACTCTGGATTTCTAACCGGTAAAGCATACATCAACTTTGGTATATGGAGCAAGCATGGAACGTGGGCGCTGTATACTGCCACTTTGCGACTTAAGGAATGTGGCTGCATTTAAATCGTTCCATTACCACCGAGTGGTAGTACTAGCCCCATGT""".split()
    K = 15
    N = 2000
    LAUNCHES = 20
    print('\n'.join(randomized_motif_search_wrapper(LAUNCHES, DNA_STRINGS, K,
                                                     profile_builder=build_profile_columns_with_corrections,
                                                     step_builder=step_builder_with_gibbs_sampling, n=N)))